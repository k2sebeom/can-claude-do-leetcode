// Main dashboard script
let allProblems = [];
let currentFilter = 'all';

// Initialize the app
async function init() {
    await loadProblems();
    setupFilterButtons();
    renderProblems();
}

// Load all problems from the manifest
async function loadProblems() {
    try {
        // Load the manifest file generated by update_problems.py
        const response = await fetch('problems-manifest.json');

        if (!response.ok) {
            throw new Error('Failed to load manifest. Run update_problems.py to generate it.');
        }

        const manifest = await response.json();

        if (!manifest.problems || manifest.problems.length === 0) {
            throw new Error('No problems found in manifest');
        }

        // Load full problem data for each problem in the manifest
        for (const problemSummary of manifest.problems) {
            try {
                const problemResponse = await fetch(`data/${problemSummary.slug}.json`);
                if (problemResponse.ok) {
                    const problem = await problemResponse.json();
                    problem.slug = problemSummary.slug;
                    allProblems.push(problem);
                }
            } catch (error) {
                console.error(`Error loading ${problemSummary.slug}:`, error);
            }
        }

        console.log(`Loaded ${allProblems.length} problems from manifest`);
    } catch (error) {
        console.error('Error loading problems:', error);
        showError(`Failed to load problems: ${error.message}<br><br>Run <code>python update_problems.py</code> to generate the manifest.`);
    }
}

// Setup filter button handlers
function setupFilterButtons() {
    const filterButtons = document.querySelectorAll('.filter-btn');

    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            // Update active state
            filterButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            // Update filter and re-render
            currentFilter = button.dataset.filter;
            renderProblems();
        });
    });
}

// Render problems to the grid
function renderProblems() {
    const grid = document.getElementById('problemsGrid');

    // Filter problems
    const filteredProblems = currentFilter === 'all'
        ? allProblems
        : allProblems.filter(p => p.difficulty === currentFilter);

    if (filteredProblems.length === 0) {
        grid.innerHTML = `
            <div class="loading">
                <p>No problems found matching the selected filter.</p>
            </div>
        `;
        return;
    }

    // Render problem cards
    grid.innerHTML = filteredProblems.map((problem, index) => {
        const preview = stripHtml(problem.content).substring(0, 120) + '...';

        return `
            <a href="problem.html?id=${problem.slug}" class="problem-card" style="animation-delay: ${0.5 + index * 0.1}s">
                <div class="card-header">
                    <div class="problem-number">#${problem.questionId}</div>
                    <div class="difficulty-badge ${problem.difficulty.toLowerCase()}">
                        ${problem.difficulty}
                    </div>
                </div>
                <h3 class="problem-title">${problem.title}</h3>
                <p class="problem-preview">${preview}</p>
                <div class="card-footer">
                    View Solution
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M6 3L11 8L6 13" stroke="currentColor" stroke-width="2" stroke-linecap="square"/>
                    </svg>
                </div>
            </a>
        `;
    }).join('');
}

// Helper function to strip HTML tags
function stripHtml(html) {
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || '';
}

// Show error message
function showError(message) {
    const grid = document.getElementById('problemsGrid');
    grid.innerHTML = `
        <div class="loading">
            <p style="color: var(--color-hard);">${message}</p>
        </div>
    `;
}

// Start the app when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}
